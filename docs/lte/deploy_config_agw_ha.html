<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Configure AGW for HA · Magma Documentation</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="# Configure Access Gateway for High-Availability"/><meta name="docsearch:version" content="1.8.0"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Configure AGW for HA · Magma Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://magma.github.io/magma/"/><meta property="og:description" content="# Configure Access Gateway for High-Availability"/><meta property="og:image" content="https://magma.github.io/magma/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://magma.github.io/magma/img/docusaurus.png"/><link rel="shortcut icon" href="/magma/img/icon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script type="text/javascript" src="/init.js"></script><script src="/magma/js/scrollSpy.js"></script><link rel="stylesheet" href="/magma/css/main.css"/><script src="/magma/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/magma/"><img class="logo" src="/magma/img/magma-logo.svg" alt="Magma Documentation"/><h2 class="headerTitleWithLogo">Magma Documentation</h2></a><a href="/magma/versions"><h3>1.8.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="https://magmacore.org" target="_self">Magma Website</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="/magma/" target="_self">Docs</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://github.com/magma" target="_self">Code</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://github.com/magma/magma/wiki/Contributor-Guide" target="_self">Contributing</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://wiki.magmacore.org/" target="_self">Wiki</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="configure-access-gateway-for-high-availability"></a><a href="#configure-access-gateway-for-high-availability" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configure Access Gateway for High-Availability</h1>
<p>This document outlines the necessary steps to deploy and configure a
Magma access gateway on AWS. This document also outlines configuring the AWS
gateway to serve as a secondary to a primary gateway running at an edge site.</p>
<h2><a class="anchor" aria-hidden="true" id="deployment"></a><a href="#deployment" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deployment</h2>
<h3><a class="anchor" aria-hidden="true" id="build-agw-ami"></a><a href="#build-agw-ami" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Build AGW AMI</h3>
<p>Steps:</p>
<ol>
<li>Download packer onto your host machine at <a href="https://www.packer.io/downloads.html">https://www.packer.io/downloads.html</a></li>
<li>Run the following</li>
</ol>
<pre><code class="hljs">[~] cd magma/orc8r/tools/packer
[~/magma/orc8r/tools/packer] packer build -force <span class="hljs-string">\</span>
    -<span class="hljs-keyword">var</span> <span class="hljs-string">"aws_access_key=YOUR_ACCESS_KEY"</span> <span class="hljs-string">\</span>
    -<span class="hljs-keyword">var</span> <span class="hljs-string">"aws_secret_key=YOUR_SECRET_KEY"</span> <span class="hljs-string">\</span>
    -<span class="hljs-keyword">var</span> <span class="hljs-string">"subnet=YOUR_SUBNET"</span> <span class="hljs-string">\</span>
    -<span class="hljs-keyword">var</span> <span class="hljs-string">"vpc=YOUR_VPC"</span> <span class="hljs-string">\</span>
    debian-stretch-aws.json
</code></pre>
<p>YOUR_SUBNET and YOUR_VPC should specify an existing subnet and vpc on your AWS
region. The choice of subnet and vpc won't affect the final box. These are the
subnet/vpc which the box is launched into while building.</p>
<p>The result should show</p>
<pre><code class="hljs">=<span class="ruby">=&gt; Builds finished. The artifacts of successful builds <span class="hljs-symbol">are:</span>
</span>-<span class="ruby">-&gt; amazon-<span class="hljs-symbol">ebs:</span> AMIs were <span class="hljs-symbol">created:</span>
</span>us-west-1: ami-0f1c9db5a767a0296
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="deploy-agw-ami"></a><a href="#deploy-agw-ami" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deploy AGW AMI</h3>
<p>On AWS:</p>
<ol>
<li>Navigate to the EC2 Service</li>
<li>Select <code>Launch Instance</code></li>
<li>Select the AMI that was built in the previous step. This AMI will exist
under <code>My AMIs</code> section.</li>
<li>On page <code>Choose an Instance Type</code>, select a c4.xlarge instance type. Proceed
to <code>Configure Instance Details</code>.</li>
<li>On page <code>Configure Instance Details</code>, use the default settings. Proceed to
<code>Add Storage</code>.</li>
<li>On page <code>Add Storage</code>, use default of 8gb. Proceed to <code>Add Tags</code>.</li>
<li>On page <code>Add Tags</code>, optionally add tags (e.g. <code>Magma Secondary Gateway</code>)
to identify this as a secondary.
Magma AGW. Proceed to <code>Configure Security Group</code>.</li>
<li>On page “Configure Security Group”, create a new security group with the
rules listed below. It is advised to limit the source IPs to the subnet that i
the primary gateway resides in for all rules other than SSH. Proceed to
<code>Review and Launch</code>.</li>
</ol>
<table>
<thead>
<tr><th>Type</th><th>Protocol</th><th>Port Range</th><th>Source</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td>SSH</td><td>TCP</td><td>22</td><td>0.0.0.0/0</td><td>-</td></tr>
<tr><td>SCTP (132)</td><td>SCTP (132)</td><td>All</td><td>0.0.0.0/0</td><td>-</td></tr>
<tr><td>Custom TCP</td><td>TCP</td><td>3386</td><td>0.0.0.0/0</td><td>-</td></tr>
<tr><td>All UDP</td><td>UDP</td><td>0 - 65535</td><td>0.0.0.0/0</td><td></td></tr>
<tr><td>All ICMP - IPv4</td><td>ICMP</td><td>All</td><td>0.0.0.0/0</td><td>-</td></tr>
</tbody>
</table>
<ol>
<li>Review that the selected settings are as described here. Then proceed to
<code>Launch</code>.</li>
<li>Select <code>Create a new key pair</code>, then save the key pair created to your host
machine. This pair will be used to access the gateway, so ensure the pair is
saved in a safe and durable location.</li>
<li>Finish by selecting <code>Launch Instances</code>.</li>
</ol>
<h3><a class="anchor" aria-hidden="true" id="eni-configuration"></a><a href="#eni-configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ENI Configuration</h3>
<p>Before installing Magma, we will add a second interface to gateway by creating
an ENI and attaching it to the EC2 instance.</p>
<ol>
<li>In the EC2 service on AWS, navigate to the <code>Network Interfaces</code> section
under the <code>Network and Security</code> tab on the side panel.</li>
<li>Select <code>Create network interface</code> in the upper right corner.</li>
<li>On the <code>Create network interface</code> configuration page, select the subnet for
the ENI. To work properly, this subnet cannot be the same subnet that the
EC2 instance was deployed with. These subnets must be in the same availability
zone though.</li>
<li>Select the same subnet that was used to deploy the EC2 instance.</li>
<li>Once configured, select <code>Create network interface</code>.</li>
<li>Navigate to the EC2 instances page.</li>
<li>Find the recently deployed EC2 instance on the left hand side. Then select
<code>Actions</code> → <code>Networking</code> → <code>Attach network interface</code>.</li>
<li>On page <code>Attach network interface</code>, select the recently created ENI and then
click <code>Attach</code>.</li>
</ol>
<h3><a class="anchor" aria-hidden="true" id="install-magma"></a><a href="#install-magma" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Install Magma</h3>
<ol>
<li>Find the public IP for the gateway instance by navigating to <code>Instances</code> on
the AWS EC2 service. Select the instance and copy the <code>Public IPv4 Address</code> in
the instance summary.</li>
<li>Add the AWS gateway key that was created when the instance was launched:
<code>ssh-add ~/.ssh/aws_key.pem</code></li>
<li>SSH to EC2 instance using the public IP from step 1:
<code>ssh admin@&lt;instance_public_ip&gt;</code></li>
<li>Now install Magma</li>
</ol>
<pre><code class="hljs">[<span class="hljs-symbol">admin@<span class="hljs-keyword">&lt;public_ip&gt;</span></span>~/] sudo su
[<span class="hljs-symbol">root@<span class="hljs-keyword">&lt;public_ip&gt;</span></span>:/home/admin] wget https:<span class="hljs-comment">//raw.githubusercontent.com/facebookincubator/magma/v1.4/lte/gateway/deploy/agw_install.sh</span>
[<span class="hljs-symbol">root@<span class="hljs-keyword">&lt;public_ip&gt;</span></span>:/home/admin] bash agw_install cloud
`
</code></pre>
<p>When  you see &quot;AGW installation is done.&quot; It means that your AGW installation
is done, you can make sure magma is running by executing:</p>
<pre><code class="hljs">service <span class="hljs-symbol">magma@</span>* status
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="access-gateway-configuration"></a><a href="#access-gateway-configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Access Gateway Configuration</h3>
<ol>
<li>Follow the <a href="https://magma.github.io/magma/docs/lte/deploy_config_agw">configuration steps</a> to register the new gateway.</li>
<li>To configure the gateway to serve as a secondary use the Orc8r API (NMS does
not currently support this functionality).
<ol>
<li>Use the POST request endpoint <code>/lte/{network_id}/gateway_pools</code> to
create a new gateway pool.</li>
<li>Add the primary gateway(s) to the pool via endpoint
<code>/lte/{network_id}/gateways/{gateway_id}/cellular/pooling</code>.
<ol>
<li>MME code should differ for each gateway in the pool.</li>
<li>MME relative capacity should be set to 255 for each primary</li>
</ol></li>
<li>Add the secondary (AWS) gateway to the pool via endpoint
<code>/lte/{network_id}/gateways/{gateway_id}/cellular/pooling</code>.
<ol>
<li>MME code should differ for each gateway in the pool.</li>
<li>MME relative capacity should be set to 1 for the secondary</li>
</ol></li>
</ol></li>
<li>To enable secondary AGW to retrieve the connection state of the primary
instances, the default value of <code>use_ha: false</code> should be changed to
<code>use_ha: true</code> in <code>/etc/magma/mme.yml</code>. This configuration is mainly for
Active-Standby configuration and should not be used if an Active-Active
configuration is desired. When set as true, secondary AGW starts offloading UEs
camped on it back to the primary instances when the primary instances come back
up and start syncing up the states of connected eNBs to the orc8r.</li>
<li>If the secondary AGW is in a different network with its eth1 interface
configured with a private IP address, S1-U IP address needs to be configured
with the public IP address of the interface separately as by default it will be
configured with the eth1 IP address that is private.
<ol>
<li>add &quot;ipv4_sgw_s1u_addr&quot;: **** &quot;IP_ADDRESS_STRING&quot; via the endpoint
<code>/lte/{network_id}/gateways/{gateway_id}/cellular/epc</code>, where
IP_ADDRESS_STRING is a CIDR formatted IPv4 address, e.g., 203.0.113.25/32.</li>
</ol></li>
<li>If eNB is behind a different NAT than the AGW instance, its S1-U IP address
communicated (with AGW instance) over the S1-MME interface is a private IP
address. Then, eNB will not be reachable in the user plane (i.e., GTP-U traffic
will not be routable back to eNB). To remedy this situation, assuming that the
eNB uses the same routable IP address for S1-MME connection and S1-U
connection, it is possible to force MME overwrite the S1-U private IP address
with the public one during bearer context set up by changing the
<code>enable_gtpu_private_ip_correction: false</code> to
<code>enable_gtpu_private_ip_correction: true</code> in <code>/etc/magma/mme.yml</code> after
ssh-ing into the AGW instance.</li>
</ol>
<p>Note: The current functionality supports multiple primaries using the same
secondary gateway. However the ENBs configured for the primaries must not
overlap.</p>
<h3><a class="anchor" aria-hidden="true" id="enodeb-configuration"></a><a href="#enodeb-configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enodeb Configuration</h3>
<p>Any enodebs that will be used in the HA pool should be added to both the
primary and secondary gateway via the NMS.</p>
<p>Make sure that your eNB supports MME pooling also known as S1-Flex as Magma HA
feature relies on this capability. eNBs must be configured with MME pool using
the management interface for the eNB vendor. The primary and secondary AGW’s
routable ip addresses assigned for eth1 must be used in this configuration.
Make sure that eNB simultaneously connects to each MME ip address in its pool
and there are sctp heartbeat requests and responses on each AGW.</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#deployment">Deployment</a><ul class="toc-headings"><li><a href="#build-agw-ami">Build AGW AMI</a></li><li><a href="#deploy-agw-ami">Deploy AGW AMI</a></li><li><a href="#eni-configuration">ENI Configuration</a></li><li><a href="#install-magma">Install Magma</a></li><li><a href="#access-gateway-configuration">Access Gateway Configuration</a></li><li><a href="#enodeb-configuration">Enodeb Configuration</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="copyright">Copyright © 2025 The Magma Authors</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'f95caeb7bc059b294eec88e340e5445b',
                indexName: 'magma',
                inputSelector: '#search_input_react'
              });
            </script></body></html>