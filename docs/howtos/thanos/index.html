<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Thanos · Magma Documentation</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="# Scaled Metrics with Thanos"/><meta name="docsearch:version" content="1.8.0"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Thanos · Magma Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://magma.github.io/magma/"/><meta property="og:description" content="# Scaled Metrics with Thanos"/><meta property="og:image" content="https://magma.github.io/magma/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://magma.github.io/magma/img/docusaurus.png"/><link rel="shortcut icon" href="/magma/img/icon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script type="text/javascript" src="/init.js"></script><script src="/magma/js/scrollSpy.js"></script><link rel="stylesheet" href="/magma/css/main.css"/><script src="/magma/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/magma/"><img class="logo" src="/magma/img/magma-logo.svg" alt="Magma Documentation"/><h2 class="headerTitleWithLogo">Magma Documentation</h2></a><a href="/magma/versions"><h3>1.8.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="https://magmacore.org" target="_self">Magma Website</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="/magma/" target="_self">Docs</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://github.com/magma" target="_self">Code</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://github.com/magma/magma/wiki/Contributor-Guide" target="_self">Contributing</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://wiki.magmacore.org/" target="_self">Wiki</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="scaled-metrics-with-thanos"></a><a href="#scaled-metrics-with-thanos" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Scaled Metrics with Thanos</h1>
<p><a href="https://thanos.io/">Thanos</a> is an open-sourced scaled prometheus solution used
to provide features like global query view, unlimited retention, and downsampling
and compaction. Orchestrator provides large deployments the option to deploy
with Thanos in order to have a more robust metrics pipeline.</p>
<h2><a class="anchor" aria-hidden="true" id="deploying-orc8r-with-thanos"></a><a href="#deploying-orc8r-with-thanos" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deploying Orc8r with Thanos</h2>
<p>The terraform module makes deploying Thanos very easy. In your <code>main.tf</code> you
just need to set the following values:</p>
<pre><code class="hljs"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">orc8r</span> {</span>
    thanos_enabled = <span class="hljs-literal">true</span>
}

<span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">orc8r</span>-<span class="hljs-title">app</span> {</span>
  thanos_enabled = <span class="hljs-literal">true</span>
  thanos_object_store_bucket_name = <span class="hljs-string">"&lt;globally-unique-bucket-name&gt;"</span>
}
</code></pre>
<p>Choose a value for <code>thanos_object_store_bucket_name</code> that will be globally
(across all of AWS) unique, but other than that the value doesn't matter.</p>
<p>That's all you need to do to deploy with Thanos! All interacting components
will be adjusted accordingly, so the NMS/Grafana will work the same as before.
If you don't care about the internals you can stop reading here.</p>
<p>If you run <code>kubectl --namespace orc8r get pods</code> it should now look like this:</p>
<pre><code class="hljs">NAME                                             READY   STATUS    RESTARTS   AGE
fluentd<span class="hljs-number">-6f</span>b9f57dff-ljmfw                         <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">24</span>h
fluentd<span class="hljs-number">-6f</span>b9f57dff-p54p9                         <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">24</span>h
nms-magmalte-f4bbf4cfb-tqblm                     <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">24</span>h
nms-nginx-proxy<span class="hljs-number">-57</span>b8585d6<span class="hljs-number">-4</span>ml6s                  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">24</span>h
orc8r-alertmanager<span class="hljs-number">-84</span>d79f774b<span class="hljs-number">-4</span>svrs              <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">24</span>h
orc8r-alertmanager-configurer<span class="hljs-number">-68</span>d6c55c9c<span class="hljs-number">-6</span>q9xg   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">24</span>h
orc8r-controller<span class="hljs-number">-7494</span>c96646<span class="hljs-number">-4</span>w4jp                <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">20</span>h
orc8r-controller<span class="hljs-number">-7494</span>c96646<span class="hljs-number">-7f</span>cg5                <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">20</span>h
orc8r-nginx<span class="hljs-number">-5f</span>9d7f4bcc-cz5ld                     <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">20</span>h
orc8r-nginx<span class="hljs-number">-5f</span>9d7f4bcc-rszpr                     <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">20</span>h
orc8r-prometheus<span class="hljs-number">-5</span>bdd644fd8-mm8gb                <span class="hljs-number">2</span>/<span class="hljs-number">2</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">24</span>h
orc8r-prometheus-cache-f84884575<span class="hljs-number">-7</span>vw8d           <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">24</span>h
orc8r-prometheus-configurer<span class="hljs-number">-69</span>df67988-w9dc6      <span class="hljs-number">2</span>/<span class="hljs-number">2</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">20</span>h
orc8r-thanos-compact<span class="hljs-number">-66</span>dd4d974b-jwzjk            <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">20</span>h
orc8r-thanos-query<span class="hljs-number">-5</span>d5cb888bd-vm9t8              <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">114</span>m
orc8r-thanos-store<span class="hljs-number">-0</span><span class="hljs-number">-7479</span>bf59f6<span class="hljs-number">-97</span>wbp            <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">114</span>m
orc8r-user-grafana-bc644b4fc<span class="hljs-number">-28</span>nmf               <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">24</span>h
</code></pre>
<p>Notice that the prometheus pod now has another container running, this is the
<a href="https://thanos.io/v0.17/components/sidecar.md/">thanos sidecar</a>. There is another
sidecar that runs with <code>prometheus-configurer</code>, and then three more components
that run independently: compact, query, and store.</p>
<h2><a class="anchor" aria-hidden="true" id="advanced-configuration-options"></a><a href="#advanced-configuration-options" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Advanced configuration options</h2>
<p>The default infrastructure setup deploys an additional node for Thanos, since
there is one component that requires significant on-node ephemeral storage.
However, you may want to deploy more nodes if you want to make sure thanos
components run on different nodes than the rest of orc8r. To do that you can
override the default value for <code>thanos_worker_groups</code> in the <code>orc8r</code> module.
The default value is:</p>
<pre><code class="hljs">[
    {
      <span class="hljs-attr">name</span>                 = <span class="hljs-string">"thanos-1"</span>
      <span class="hljs-attr">instance_type</span>        = <span class="hljs-string">"m5d.xlarge"</span>
      <span class="hljs-attr">asg_desired_capacity</span> = <span class="hljs-number">1</span>
      <span class="hljs-attr">asg_min_size</span>         = <span class="hljs-number">1</span>
      <span class="hljs-attr">asg_max_size</span>         = <span class="hljs-number">1</span>
      <span class="hljs-attr">autoscaling_enabled</span>  = <span class="hljs-literal">false</span>
      <span class="hljs-attr">kubelet_extra_args</span> = <span class="hljs-string">"--node-labels=compute-type=thanos"</span>
    },
  ]
</code></pre>
<p>To add more workers, either adjust the <code>asg_...</code> values in that object, or add
another entry to that array of worker groups. To specify thanos components to
run on specific nodes, just set the following variables in the <code>orc8r-app</code> module:</p>
<pre><code class="hljs"><span class="hljs-attr">thanos_query_node_selector</span> = <span class="hljs-string">"thanos"</span>
<span class="hljs-attr">thanos_store_node_selector</span> = <span class="hljs-string">"thanos"</span>
</code></pre>
<blockquote>
<p>Note: set the value to the same value you used for <code>--node-labels=compute-type=&lt;value&gt;</code>
in order to run on that worker group</p>
</blockquote>
<p>These are advanced configuration options, and we don't expect them to be necessary,
but are available to give more fine-grained control over your deployment.</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#deploying-orc8r-with-thanos">Deploying Orc8r with Thanos</a></li><li><a href="#advanced-configuration-options">Advanced configuration options</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="copyright">Copyright © 2025 The Magma Authors</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'f95caeb7bc059b294eec88e340e5445b',
                indexName: 'magma',
                inputSelector: '#search_input_react'
              });
            </script></body></html>