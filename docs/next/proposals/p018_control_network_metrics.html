<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Export Control Path Network Metrics · Magma Documentation</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="# Proposal: Export Control Path Network Metrics"/><meta name="docsearch:version" content="next"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Export Control Path Network Metrics · Magma Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://magma.github.io/magma/"/><meta property="og:description" content="# Proposal: Export Control Path Network Metrics"/><meta property="og:image" content="https://magma.github.io/magma/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://magma.github.io/magma/img/docusaurus.png"/><link rel="shortcut icon" href="/magma/img/icon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script type="text/javascript" src="/init.js"></script><script src="/magma/js/scrollSpy.js"></script><link rel="stylesheet" href="/magma/css/main.css"/><script src="/magma/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/magma/"><img class="logo" src="/magma/img/magma-logo.svg" alt="Magma Documentation"/><h2 class="headerTitleWithLogo">Magma Documentation</h2></a><a href="/magma/versions"><h3>next</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="https://magmacore.org" target="_self">Magma Website</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="/magma/" target="_self">Docs</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://github.com/magma" target="_self">Code</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://github.com/magma/magma/wiki/Contributor-Guide" target="_self">Contributing</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://wiki.magmacore.org/" target="_self">Wiki</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Access Gateway</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Getting Started<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/magma/docs/next/basics/introduction">Introduction</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/basics/prerequisites">Prerequisites</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/basics/quick_start_guide">Quick Start Guide</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/bazel/agw_with_bazel">AGW with Bazel</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Tutorials<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Operate your own private mobile network with Charmed Magma</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/tutorials/00_overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/tutorials/01_getting_started">1. Getting Started</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/tutorials/02_deploying_magma_orchestrator">2. Deploying Magma Orchestrator</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/tutorials/03_deploying_magma_agw">3. Deploying Magma Access Gateway</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/tutorials/04_integrating_agw_with_orc8r">4. Integrating Magma Access Gateway with Magma Orchestrator</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/tutorials/05_deploying_the_radio_simulator">5. Deploying the radio simulator</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/tutorials/06_simulating_user_traffic">6. Simulating user traffic</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/tutorials/06_destroying_the_env">7. Destroying the environment</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Usage<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">How-To</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/ue_metering">UE Usage Metering</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/config_agw_bridged">AGW Non-NAT Mode</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/5g_nsa_support">5G NSA Support</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/call_tracing">Call Tracing</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/events_monitoring">Events Monitoring</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/ipv6_agw">(Experimental) Configure IPv6 AGW</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/he_api">Header Enrichment</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/inbound_roaming">Inbound Roaming</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/l3_transport">L3 transport for AGW</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/network_probe">Network Probe</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/package">Packaging</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">NMS</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/dashboard">Dashboard</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/equipment">Equipment</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/network">Network</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/subscriber">Subscriber</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/traffic">Traffic</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/metrics">Metrics</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/alerts">Alerts</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/federation">Federation</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/admin">Admin</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/tips_and_tricks">Tips and Tricks</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Architecture<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Access Gateway</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/architecture_overview">Overview</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Orchestrator</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/architecture_overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/architecture_modularity">Modularity</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/architecture_security">Security</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">NMS</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/architecture_overview">Overview</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">FeG</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/feg/architecture_overview">Overview</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Domain Proxy</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/dp/architecture_overview">Overview</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Deploy<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">General</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/general/aws_cloudstrapper">AWS Cloudstrapper Install</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Access Gateway</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/deploy_install">Install AGW</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/deploy_install_docker">Install Docker AGW</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/deploy_config_agw">Configure AGW</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/deploy_config_enodebd">Configure eNodeB</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/deploy_config_apn">Configure an APN</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/deploy_agw_using_juju">Deploy AGW using Juju</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/build_install_magma_pkg_in_agw">Build and install a magma package in AGW</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Orchestrator</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/deploy_intro">Introduction</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/deploy_install">Install Orchestrator</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/deploy_using_ansible">Deploy Orchestrator using Ansible (Beta)</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/deploy_using_juju">Deploy Orchestrator using Juju (Beta)</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/deploy_terraform_options">Terraform Options</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/deploy_faq">FAQs</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">NMS</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/deploy_setup">Set Up NMS</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Federation Gateway</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/feg/deploy_intro">Introduction</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/feg/deploy_build">Build FeG</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/feg/deploy_install">Install FeG</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Domain Proxy</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/dp/deploy_build">Build and deployment</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Carrier WiFi</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/cwf/deploy_intro">Introduction</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/cwf/deploy_build">Building Carrier Wifi Gateway</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/cwf/deploy_install">Installing Carrier Wifi Gateway</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Configure<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Access Gateway</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/configure_agw_ha">Configure AGW for HA</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/configure_sentry">Sentry Integration</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Orchestrator</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/configure_thanos">Thanos</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Federation Gateway</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/feg/configure_federation">Configure FeG</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">NMS</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/nms_organizations">Multitenancy (Organizations)</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Upgrade<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">General</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/general/upgrade_intro">Introduction</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Access Gateway</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/upgrade_debian_to_ubuntu">Migrate AGWs to Ubuntu</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/upgrade_1_6">Upgrade to v1.6</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/upgrade_1_5">Upgrade to v1.5</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/upgrade_1_4">Upgrade to v1.4</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/upgrade_1_3">Upgrade to v1.3</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/upgrade_1_2">Upgrade to v1.2</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/upgrade_1_1">Upgrade to v1.1</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Orchestrator</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/upgrade_intro">Introduction</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/upgrade_1_6">Upgrade to v1.6</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/upgrade_1_5">Upgrade to v1.5</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/upgrade_1_4">Upgrade to v1.4</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/upgrade_1_3">Upgrade to v1.3</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/upgrade_1_2">Upgrade to v1.2</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/upgrade_1_1">Upgrade to v1.1</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Debug<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">General</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/troubleshooting/agw_healthcheck">Perform Access Gateway health check</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/troubleshooting/agw_unable_to_checkin">Access Gateway Unable to Check-in to Orchestrator</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/troubleshooting/user_unable_to_attach">User is unable to attach to Magma</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/troubleshooting/update_certificates">Update rootCA and controller SSL certificates</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/troubleshooting/generate_admin_operator_certificates">Generate and update admin_operator certificates</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/troubleshooting/analyze_service_crashes_in_agw">Analyze Service crashes in AGW</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/howtos/troubleshooting/datapath_connectivity">Debugging AGW datapath issues</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Access Gateway</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/debug_show_tech">Show Tech</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/debug_dp_probe">Datapath Probe CLI</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/debug_user_control_plane">User Control Plane trace CLI</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Federated Gateway</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/feg/debug_cli">FeG CLI</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Carrier WiFi</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/cwf/healthchecker">Health Checker</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/cwf/pipelined_packet_tracer_debugging">Pipelined Packet Tracer Debugging</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Orchestrator</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/debug_logs">View Logs</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">NMS</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/alerts_troubleshooting">Alerts</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Domain Proxy</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/dp/debug_logs">Debugging and logs</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Contribute<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/magma/docs/next/contributing/contribute_github">Community</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/contributing/contribute_codeowners">Codeowners Workflow</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/contributing/contribute_tsc_norms">TSC Processes</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/contributing/contribute_proposals">Proposals Process</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Technical Reference<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">General</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/resources/ref_pcap">PCAP Collection</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/resources/ref_useful_links">Useful Links</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/resources/ref_magma_metrics">Life of a Magma Metric</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Access Gateway</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/readme_agw">Services/Sub-Components</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/dev_notes">Developer Notes</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/openvswitch">Magma Datapath</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/pipelined">Pipelined</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/ebpf_datapath">Magma eBPF Datapath</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/ipfix">Magma IPFIX Support</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/pipelined_tests">Pipelined testing framework</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/dev_unit_testing">Test AGW</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/tr069">Add eNB TR-069 Support</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/s1ap_tests">S1AP Integration Tests</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/eventd">Event Reporting</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/sessiond">Session Management in Magma</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/access_service_restrictions">Restricting Network Access</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/dev_teid_allocation">TEID Allocation</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/integrated_5g_sa">Integrated 5G SA</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/extended_5g_sa_features">Extended 5G SA Features</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/suci_extensions">SUCI Extensions</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/redirectd">Redirection</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/readme_callflow">Building the Callflow</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Orchestrator</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/dev_rest_api">REST API</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/dev_build">Build Orchestrator</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/dev_testing">Test Orchestrator</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/dev_minikube">Deploy on Minikube</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/dev_security">Security</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/dev_indexers">State Indexers</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/dev_sub_digests">Subscriber Digests</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/dev_rest_api_auth">REST API Auth</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/dev_dependencies">Module Dependencies</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/dev_gateway_registration">Gateway Registration</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/dev_aws_stack">AWS Stack</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">NMS</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/dev_spacing">Spacing Guidelines</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/dev_testing">Test NMS</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/dev_themes">Themes</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/nms/dev_components">Components</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Federation Gateway</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/feg/dev_testing">Test Federation Gateway</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/feg/docker">FeG Docker Setup</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/feg/s1ap_federated_tests">S1AP Federated Integration Tests</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/feg/session_proxy">Session Proxy</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Carrier WiFi</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/cwf/dev_testing">Test CWAG</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Design Documents<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">General</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p001_vpn_config_from_api">Configurable VPN from Orchestrator API</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p005_call_tracing">Call Tracing for Troubleshooting</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p014_proposal_process">Magma Proposals</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p015_tech_debt_week">Tech Debt Week Processes</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p017_apn_refactoring">APN Refactoring Proposal</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Access Gateway</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p003_qos_enforcement">QoS Policy Configuration</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p004_fua_restrict_feature">Service Restriction Feature</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p007_header_enrichment">Header enrichment</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p008_apn_correction">MME APN Correction</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p013_Ubuntu_upgrade">AGW Ubuntu upgrade</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/magma/docs/next/proposals/p018_control_network_metrics">Export Control Path Network Metrics</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p019_enodeb_cbrs_support">Enodebd CBRS Support</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p020_sgi_tunnel_transport">L3 transport for AGW</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Orchestrator</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p002_scaled_prometheus_pipeline">Scaled Prometheus Pipeline</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p010_subscriber_scaling">Subscriber Scaling</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p011_victoriametrics">VictoriaMetrics as Magma&#x27;s TSDB</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">NMS</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p009_nms_mariadb_migration">NMS MariaDB Migration</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/proposals/p016_nms_regression_testing">NMS Regression Testing</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">FAQ<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/magma/docs/next/faq/faq_magma">Frequently Asked Questions</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="proposal-export-control-path-network-metrics"></a><a href="#proposal-export-control-path-network-metrics" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Proposal: Export Control Path Network Metrics</h1>
<p>Author(s): @waqaraqeel</p>
<p>Last updated: 07/13/2021</p>
<p>Discussion at
<a href="https://github.com/magma/magma/issues/8028">https://github.com/magma/magma/issues/8028</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="context--scope"></a><a href="#context--scope" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Context &amp; scope</h2>
<p>Services running on the access gateway communicate with the orc8r and generate
control traffic. We do not have visibility into the amount, patterns, and
service-level breakdown of this traffic. As we try to minimize control plane
bandwidth consumption for our deployment partners, especially those with
satellite backhaul, visibility into bandwidth consumption is crucial. This
proposal details a <strong>design for collecting and exporting control plane network
metrics from the access gateway to the orchestrator and NMS</strong>.</p>
<p>See <a href="resources/ref_magma_metrics">Life of a Magma Metric</a> for context on
existing Magma metrics pipeline.</p>
<h3><a class="anchor" aria-hidden="true" id="goals"></a><a href="#goals" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Goals</h3>
<ol>
<li><p>On the access gateway, record byte counts grouped by AGW source service and
destination cloud service. For non-Magma traffic, only record the Linux binary
that sends traffic.</p></li>
<li><p>Export byte counts as Prometheus metrics on the NMS UI.</p></li>
<li><p>Minimize performance penalty on the gateway for network metrics collection.</p></li>
<li><p>Minimize required infrastructure changes for metrics export and for
deployment.</p></li>
</ol>
<h3><a class="anchor" aria-hidden="true" id="non-goals"></a><a href="#non-goals" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Non-goals</h3>
<ol>
<li>Change collection/export methods for existing data-path metrics.</li>
</ol>
<h2><a class="anchor" aria-hidden="true" id="proposal"></a><a href="#proposal" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Proposal</h2>
<p><img src="/magma/docs/assets/orc8r/control_network_metrics.png" alt="Network metrics path"></p>
<p>To collect relevant byte count metrics, we propose using an
<a href="https://ebpf.io/what-is-ebpf/">eBPF</a> program. eBPF is a modern Linux kernel
feature that allows running sandboxed programs inside the kernel without having
to change kernel source code or loading privileged/risky kernel modules. The
Linux kernel verifies eBPF programs to ensure safety and termination, and
provide certain performance guarantees [1].</p>
<p>We will use the <a href="https://github.com/iovisor/bcc/">BCC toolkit</a> for writing and
loading our eBPF monitoring program. BCC makes it easier to write eBPF programs
by providing clean abstractions for kernel instrumentation, and Python and Lua
libraries for writing user space front-end programs that communicate with the
kernel space eBPF program. We will write a Python front-end since many of our
existing services already use Python, and we have convenient infrastructure for
exporting Prometheus metrics from Python services.</p>
<p>We will create a new Python service called <code>kernsnoopd</code> (not <code>netsnoopd</code> as this
service can later become a home for more observability through eBPF). Upon
service start, <code>kernsnoopd</code> will compile the eBPF kernel instrumentation program
and load it. It will read <code>collect_interval</code> from its configuration. Every
<code>collect_interval</code> seconds, <code>kernsnoopd</code> will read the counters from the eBPF
program into Prometheus counters and clear the eBPF counters.</p>
<p>The byte counts read from eBPF will be stored into Prometheus counters
<code>magma_bytes_sent_total</code> and <code>linux_bytes_sent_total</code>. The
<code>magma_bytes_sent_total</code> counter will have the label <code>service_name</code> indicating
AGW source service, and <code>dest_service</code> indicating the cloud destination service.
The <code>linux_bytes_sent_total</code> counter will only have a <code>binary_name</code> label. On
the loopback interface, only the port on which <code>control_proxy</code> is listening for
traffic will be observed. This port and other information related to Magma
services can be read from the
<a href="https://sourcegraph.com/github.com/magma/magma@v1.6.0/-/blob/orc8r/gateway/python/magma/common/service_registry.py"><code>ServiceRegistry</code></a>.
On other interfaces (see <a href="#open-issues">Open Issues</a>), all traffic will be
observed. <code>task-&gt;comm</code> from the kernel will be used to identify the binary
triggering traffic. In case of Python services, the binary name is <code>python3</code> so
command line arguments (e.g. <code>magma.main.subscriberdb</code>) will be used to infer
the source service name.
All traffic from the AGW to the Orc8r will be going to
the same destination port, so we may have to look at the <a href="https://sourcegraph.com/github.com/magma/magma@v1.6/-/blob/orc8r/gateway/python/magma/common/service_registry.py?L165">HTTP authority
header</a>
to infer destination service.</p>
<p>Once Prometheus counter values have been set, they will follow the existing
Magma metrics path: the <code>magmad</code> service will read the counters from
<code>kernsnoopd</code> and upload them to <code>metricsd</code> at the orchestrator every
<code>sync_interval</code> seconds. The NMS UI will then display these metrics. The <a href="resources/ref_magma_metrics">Life
of a Magma Metric</a> document describes this path in
detail.</p>
<p>This design achieves <a href="#goals">goals</a> #1 and #2. The choice of eBPF minimizes
performance penalty (discussed <a href="#performance">here</a>) by putting compiled code
into the kernel and avoiding raw packet captures. We also utilize the existing
metrics plumbing for Python services.</p>
<p>Now we show a prototype of the eBPF program <code>kernsnoopd</code> will use:</p>
<pre><code class="hljs css language-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;bcc/proto.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/sched.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;uapi/linux/ptrace.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;net/sock.h&gt;</span></span>

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key_t</span> {</span>
  <span class="hljs-comment">// binary name (task-&gt;comm in the kernel)</span>
  <span class="hljs-keyword">char</span> comm[TASK_COMM_LEN];
  u32 pid;
  <span class="hljs-comment">// source port and destination IP address, port</span>
  u32 daddr;
  u16 dport;
};

<span class="hljs-comment">// Create a hash map with `key_t` as key type and u64 as value type</span>
BPF_HASH(dest_counters, struct <span class="hljs-keyword">key_t</span>);

<span class="hljs-comment">// Attach kprobe for the `tcp_sendmsg` syscall</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">kprobe__tcp_sendmsg</span><span class="hljs-params">(struct pt_regs *ctx, struct sock *sk, struct msghdr *msg, <span class="hljs-keyword">size_t</span> <span class="hljs-built_in">size</span>)</span> </span>{
  u16 dport = <span class="hljs-number">0</span>, family = sk-&gt;__sk_common.skc_family;

  <span class="hljs-comment">// only IPv4</span>
  <span class="hljs-keyword">if</span> (family == AF_INET) {
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key_t</span> <span class="hljs-title">key</span>;</span>

    <span class="hljs-comment">// read binary name, pid, source and destination IP address and port</span>
    bpf_get_current_comm(key.comm, TASK_COMM_LEN);
    key.pid = bpf_get_current_pid_tgid() &gt;&gt; <span class="hljs-number">32</span>;;
    key.daddr = sk-&gt;__sk_common.skc_daddr;
    dport = sk-&gt;__sk_common.skc_dport;
    key.dport = ntohs(dport);

    <span class="hljs-comment">// increment the counters</span>
    dest_counters.increment(key, <span class="hljs-built_in">size</span>);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

</code></pre>
<p>This program is written in restricted C (prevents direct memory access, for
example) that is suitable for LLVM compilation into BPF bytecode. It uses macros
from BCC to create a hash map data structure (<code>dest_counters</code>), and attach a
<code>kprobe</code> to the
<a href="https://elixir.bootlin.com/linux/latest/source/net/ipv4/tcp.c#L1456"><code>tcp_sendmsg</code></a>
function. This probe gets triggered just before a TCP segment transmission. Our
callback function reads the appropriate context and increments relevant counters
in the hash map.</p>
<p>Below is an example of a front-end Python program that retrieves and displays
the counters aggregated in the kernel:</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">import</span> time

<span class="hljs-keyword">from</span> bcc <span class="hljs-keyword">import</span> BPF
<span class="hljs-keyword">from</span> socket <span class="hljs-keyword">import</span> inet_ntop, ntohs, AF_INET
<span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> pack

INTERVAL = <span class="hljs-number">3</span>
TASK_COMM_LEN = <span class="hljs-number">16</span> <span class="hljs-comment"># linux/sched.h</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_table</span><span class="hljs-params">(table)</span>:</span>
    print(<span class="hljs-string">"----------------------------"</span>)
    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> table.items():
        daddr = inet_ntop(AF_INET, pack(<span class="hljs-string">"I"</span>, k.daddr))
        dport = ntohs(k.dport)
        print(<span class="hljs-string">f"<span class="hljs-subst">{k.pid}</span> sent <span class="hljs-subst">{v.value}</span> bytes to (<span class="hljs-subst">{daddr}</span>:<span class="hljs-subst">{dport}</span>)"</span>)
    print(<span class="hljs-string">"----------------------------"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># compile and load eBPF program from source file</span>
    b = BPF(src_file=<span class="hljs-string">"transmit_trace.c"</span>)

    <span class="hljs-comment"># print and clear table every INTERVAL seconds</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        time.sleep(INTERVAL)
        table = b[<span class="hljs-string">"dest_counters"</span>]
        print_table(b[<span class="hljs-string">"dest_counters"</span>])
        table.clear()
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="a-python-free-future"></a><a href="#a-python-free-future" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A Python-free Future</h3>
<p>If/when we move to a Python-free AGW, the design above can be modified depending
upon which language we choose to adopt.</p>
<p>If we choose <strong>Go</strong>, we do not have to change the eBPF program written in
restricted C as Go bindings for BCC are available in the
<a href="https://github.com/iovisor/gobpf"><code>gobpf</code></a> package. This package also provides
low-level routines to load eBPF programs from .elf files, so we can send
compiled programs to the AGW and remove clang as a dependency. However, programs
would presumably have to be compiled for various kernel versions. Pre-compiling
is not necessary though as <code>gobf</code> allows the front-end Go program to trigger
compilation just like the Python program above does.</p>
<p>If we choose <strong>C/C++</strong>, we should consider switching from BCC to
<a href="https://github.com/libbpf/libbpf"><code>libbpf</code></a>. While BCC provides C bindings to
write front-end programs, <code>libbpf</code> is a simpler alternative. This means
the <code>libbpf</code> API is not as convenient, but it supports compiling both the eBPF
program, and the front-end program into a small binary and remove clang as a
dependency on the AGW.</p>
<p>We have tools to translate Prometheus metrics for consumption at the <code>magmad</code>
service in the AGW for both Python and C/C++. Such tools don't exist in Go, but
writing those tools will presumably be part of the plan to replace Python on the
AGW with Go.</p>
<h2><a class="anchor" aria-hidden="true" id="alternatives-considered"></a><a href="#alternatives-considered" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Alternatives considered</h2>
<p>Here, we enumerate alternatives to the above design that we considered:</p>
<ol>
<li><p><a href="https://www.tcpdump.org/"><strong><code>libpcap</code></strong></a>: There are several existing
monitoring tools based on <code>libpcap</code> such as
<a href="https://github.com/raboof/nethogs">Nethogs</a> and
<a href="http://www.ex-parrot.com/~pdw/iftop/">iftop</a>. While these tools do not collect
the exact metrics required, it should be straightforward to modify them or write
a new tool based on <code>libpcap</code>. The larger issue is that <code>libpcap</code> will make a
copy of the packet from <code>skbuff</code> to a shared buffer in the kernel, which incurs
significant overhead. Moreover, we do not see any advantages of <code>libpcap</code> over
eBPF.</p></li>
<li><p><a href="https://nghttp2.org"><strong><code>nghttpx</code></strong></a>: We use <code>control_proxy</code> to proxy TLS
connections from individual services to the orchestrator. However, <code>nghttpx</code>,
the proxy implementation we use does not collect per-service byte counters.
<code>nghttpx</code> could probably be modified to collect these statistics, but that would
probably be higher development effort and may yield worse performance. Also, it
will not work if <code>proxy_cloud_connections</code> is set to <code>False</code> and services are
connecting to the cloud directly. Even if <code>proxy_cloud_connections</code> is set to
<code>True</code>, <code>nghttpx</code> will not be able to capture general traffic outside of Magma
daemons.</p></li>
<li><p><a href="https://github.com/cilium/ebpf"><strong><code>cilium/epbf</code></strong></a>: This is a pure Go eBPF
library alternative to BCC. <code>cilium/ebpf</code> has minimal external dependencies and
delivers a single binary that will contain the eBPF program, its loader and the
front-end to communicate with it. It provides a <code>bpf2go</code> tool which compiles an
eBPF program written in C and generates a Go file containing the compiled
bytecode. The API is less convenient than that of BCC. <code>cilium/ebpf</code> API is
also explicitly unstable. They state that programs will have to be updated for
future versions of the library. Moreover, we do not have a Prometheus metrics
export mechanism for Go services so that work will have to be duplicated from
Python. In short, we did not pick <code>cilium/ebpf</code> because BCC is easier to work
with, more mature, and more popular (hence more support available), and also
allows us to use existing metrics support in Python.</p></li>
<li><p><a href="https://github.com/iovisor/gobpf"><strong><code>iovisor/gobpf</code></strong></a>: These are Go
bindings for BCC. <code>gobpf</code> will allow us to reuse the BPF code we write for the
Python bindings for BCC. It also contains tools for compiling that program and
loading into the kernel from a Go binary which would contain the front-end
program. The reason we are not picking <code>gobpf</code> is because our metrics pipeline
has a transformation step from Prometheus metrics to gRPC structures for
consumption by <code>magmad</code>. We already implement this transformation in Python and
C++, but not in Go. In the future, we may implement this transformation in Go to
move gateway services from Python/C++ to Go. If we do so, we should consider
using <code>gobpf</code> for <code>kernsnoopd</code>.</p></li>
<li><p><a href="https://github.com/cloudflare/ebpf_exporter"><strong><code>cloudflare/ebpf_exporter</code></strong></a>:
This uses <code>gobpf</code> behind the scenes. It handles compiling and loading the
provided eBPF C program just like Python tools for BCC do. It allows the
frontend program to be generated from a YAML specification. <code>ebpf_exporter</code> may
have been a good choice if we were using standard Prometheus metrics collection
and export methods, but we do not. Hence, we prefer an explicit Python frontend
program.</p></li>
</ol>
<p>While the eBPF-based alternatives present above can be used to implement a wide
variety of observability tasks from inside the kernel, the non-eBPF ones are not
extendable.</p>
<h2><a class="anchor" aria-hidden="true" id="cross-cutting-concerns"></a><a href="#cross-cutting-concerns" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cross-cutting concerns</h2>
<p>There are several concerns that this proposal attempts to address:</p>
<h3><a class="anchor" aria-hidden="true" id="performance"></a><a href="#performance" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Performance</h3>
<p>Performance is a major concern for this proposal as we are putting code into the
kernel's network path on the access gateway. We benchmarked the eBPF code above
using the Spirent lab setup. Four tests were run in total, each with 600 user
devices, 5 MB download rate per device, and an attach rate of 10. The tests ran
for 30 minutes each. The <code>tcp_sendmsg</code> instrumentation was enabled for two tests
and disabled for the other two. No distinguishable downgrade in throughput was
observed when <code>tcp_sendmsg</code> instrumentation was enabled. The mean download
throughput for each of the four cases hovered around 530 Mbps.</p>
<p>For deployment, it will be important to count bytes only on the relevant
interfaces and relevant ports on the loopback interface. We want to observe
traffic on loopback as we use <code>control_proxy</code> to funnel traffic from Magma
daemons, but we want to ignore traffic on loopback that isn't destined for
<code>control_proxy</code> such as <code>redis</code> traffic or communication between <code>magmad</code> and
other daemons.</p>
<p>One way to further reduce the performance penalty is to use the TCP tracepoint
<code>sock:inet_sock_set_state</code> instead of <code>tcp_sendmsg</code>. <code>sock:inet_sock_set_state</code>
is fired when the kernel changes the state of a socket [3]. We could use this
event to collect metrics before a socket closes. However, this means that there
might be precision issues for long-running TCP streams.</p>
<p>A minor performance concern relates to compiling the kernel instrumentation
code from C to BPF bytecode and loading it onto the kernel. We have benchmarked
the prototype program above on <code>magma</code> AGW VM and across 50 runs, it takes an
average of 1.75 sec for BCC to read the program from a separate source file,
compile it and load it into the kernel. Since this will only happen when the
<code>kernsnoopd</code> service starts, it is not cause for concern.</p>
<h3><a class="anchor" aria-hidden="true" id="deployment"></a><a href="#deployment" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deployment</h3>
<p>This design will require BCC tools and Linux kernel headers to be installed on
the access gateway. Kernel headers are already installed. BCC is delivered
through apt packages <code>bpfcc-tools</code>, <code>libbpfcc</code>, and <code>python3-bpfcc</code>. Combined,
these packages have a download size of 15.5 MB and take up 63 MB of disk space
after installation (see <a href="#open-issues">Open Issues</a>).</p>
<h3><a class="anchor" aria-hidden="true" id="compatibility"></a><a href="#compatibility" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compatibility</h3>
<p>eBPF was originally introduced to the Linux kernel in 2014 with kernel version
3.15 [5]. It has been evolving since then, and the latest TCP tracepoints we
talk about were introduced in kernel version 4.16 [3]. This is not a concern
though as our access gateways are on Ubuntu Focal with kernel version 5.8+.</p>
<h3><a class="anchor" aria-hidden="true" id="observability-and-debug"></a><a href="#observability-and-debug" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Observability and Debug</h3>
<p><code>kernsnoopd</code> will provide debug logs of collected counters for observability.
Appropriate <code>nosetests</code> will be included in the implementation to support
validation and debugging. Additionally, <code>kernsnoopd</code> will also provide the
<code>GetMetrics</code> gRPC methods to expose the Prometheus metrics.</p>
<p>From the <code>GetMetrics</code> method of <code>kernsnoopd</code>, metrics enter <code>magmad</code> and follow
the general <a href="resources/ref_magma_metrics">metrics pipeline</a> which is mature and
well-tested.</p>
<h3><a class="anchor" aria-hidden="true" id="security--privacy"></a><a href="#security--privacy" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Security &amp; privacy</h3>
<p>The compiled instrumentation code from this proposal will be loaded into the
kernel, but there should not be security concerns because eBPF statically
verifies programs before loading and provides security guarantees. Unchecked
memory access is not allowed, neither are unbounded loops [6]. The total number
of instructions allowed is also limited [7].</p>
<p>The in-kernel program will be able to observe coarse network statistics for
processes running on the access gateway. Individual packets will not be
captured or inspected. Command line arguments of running processes will be
read, but they will not be stored anywhere.</p>
<h2><a class="anchor" aria-hidden="true" id="open-issues"></a><a href="#open-issues" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Open issues</h2>
<ul>
<li><p>Is 63 MB of additional disk space required to install <code>bpfcc-tools</code> on the
access gateway really not a problem? Discuss with DevOps.</p></li>
<li><p>We do not want to instrument the data path. Should we observe all interfaces
on the gateway? If not, what subset should we observe? This is crucial to
reducing performance impact of the above design.</p></li>
<li><p>Is network utilization on our access gateway usually close to 100%? Are our
gateways starving for CPU? We will design a lab experiment to quantify both the
control path and data path impact of <code>kernsnoopd</code>. This experiment will measure
AGW capacity in terms of number of UEs, varying attach/detach rates, data path
traffic. We will also aim to compensate statistically for the jitter in AGW
capacity measurements.</p></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="original-design"></a><a href="#original-design" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Original design</h2>
<p>We have arrived at the above design after a few rounds of discussion and
feedback from the team. In the original design, we had planned to</p>
<ul>
<li><p>Instrument the <code>net_dev_start_xmit</code> event, which is on the L2 network path.
The authors of <code>netqtop</code>, a similar tool included in the BCC distribution, have
benchmarked their tool and observe 1.17 usec increase in packet &quot;pingpong&quot;
latency [2]. When they benchmark bandwidth on the loopback interface, they
observe a drop of around 27% in packets per second (PPS). We also measured <a href="#performance-impact-of-l2-instrumentation">the
performance impact</a> and concluded
that it was too high. To avoid this high penalty, we switched to attaching a
<em>kprobe</em> to the <code>tcp_sendmsg</code> syscall as an L2 hook would have higher
performance impact. As a consequence, we lost the ability to observe L3 traffic
such as that generated from the ping and traceroute probes that <em>magmad</em> sends
periodically. But since those probes should not be consuming much bandwidth, we
are willing to ignore them.</p></li>
<li><p>Have packet counters in addition to byte counters. We dropped packet counters
as it is not possible to get accurate packet counts even with
<code>net_dev_start_xmit</code> because of <a href="https://en.wikipedia.org/wiki/TCP_offload_engine">NIC
offloading</a>.</p></li>
<li><p>Put destination IP address and port as labels on Prometheus counters. Each
distinct value for a label results in a separate Prometheus time series, and
since destination IP addresses and ports have very large domains, the overhead
of having separate time-series would be too high. We instead decided to label
Magma traffic by destination cloud service.</p></li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="performance-impact-of-l2-instrumentation"></a><a href="#performance-impact-of-l2-instrumentation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Performance impact of L2 instrumentation</h3>
<p>We evaluated the performance impact of instrumenting the <code>net_dev_start_xmit</code>
kernel event using the Spirent lab setup as we did for <a href="#performance"><code>tcp_sendmsg</code></a>. Two
tests were run, one with <code>net_dev_start_xmit</code> instrumentation disabled, and one
with it enabled. Each test had 600 user devices, 5 MB download rate per device,
and an attach rate of 10. The tests ran for 30 minutes each.</p>
<p>When <code>net_dev_start_xmit</code> instrumentation was disabled, the mean download
throughput was roughly 540 Mbps. When it was enabled, the mean download
throughput reduced to 430 Mbps, a 20% reduction.</p>
<p>We also stress-tested the <code>net_dev_start_xmit</code> instrumentation. The most
expensive operation in the relevant callback is incrementing a value in the BPF
hash map. We put the increment operation in a loop and iterated it <code>n</code> times.
When <code>n = 100</code>, the mean download throughput reduction was modest: from 430 Mbps
to 420 Mbps. For <code>n = 150</code> and <code>n = 175</code>, no noticeable reduction was observed
compared to <code>n = 100</code>. However, at <code>n = 200</code>, download throughput collapsed
completely and produced a mean of around 5.5 Mbps with the peak hitting 75 Mbps.
This sudden drop in throughput may have to do with excessive packet loss because
of the slow callback function.</p>
<h2><a class="anchor" aria-hidden="true" id="references"></a><a href="#references" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>References</h2>
<p>[1]: Jay Schulist, Daniel Borkmann, Alexei Starovoitov. 2018. Linux Socket
Filtering aka Berkeley Packet Filter (BPF).
<a href="https://www.kernel.org/doc/Documentation/networking/filter.txt">https://www.kernel.org/doc/Documentation/networking/filter.txt</a></p>
<p>[2]: yonghong-song. 2020. Netqtop 3037.
<a href="https://github.com/iovisor/bcc/pull/3048">https://github.com/iovisor/bcc/pull/3048</a></p>
<p>[3]: Brendan Gregg. 2018. TCP Tracepoints.
<a href="https://www.brendangregg.com/blog/2018-03-22/tcp-tracepoints.html">https://www.brendangregg.com/blog/2018-03-22/tcp-tracepoints.html</a></p>
<p>[4]: pflua-bench. 2016. <a href="https://github.com/Igalia/pflua-bench">https://github.com/Igalia/pflua-bench</a></p>
<p>[5]: Alexei Starovoitov. 2014. net: filter: rework/optimize internal BPF
interpreter's instruction set.
<a href="https://www.kernel.org/doc/Documentation/networking/filter.txt">https://www.kernel.org/doc/Documentation/networking/filter.txt</a></p>
<p>[6]: Alexei Starovoitov. 2019. bpf: introduce bounded loops.
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next.git/commit/?id=2589726d12a1b12eaaa93c7f1ea64287e383c7a5">https://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next.git/commit/?id=2589726d12a1b12eaaa93c7f1ea64287e383c7a5</a></p>
<p>[7]: Quentin Monnet. 2021. eBPF Updates #4: In-Memory Loads Detection,
Debugging QUIC, Local CI Runs, MTU Checks, but No Pancakes.
<a href="https://ebpf.io/blog/ebpf-updates-2021-02">https://ebpf.io/blog/ebpf-updates-2021-02</a></p>
<p>[8]: Ivan Babrou. 2018. eBPF overhead benchmark.
<a href="https://github.com/cloudflare/ebpf_exporter/tree/master/benchmark">https://github.com/cloudflare/ebpf_exporter/tree/master/benchmark</a></p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/magma/docs/next/proposals/p013_Ubuntu_upgrade"><span class="arrow-prev">← </span><span>AGW Ubuntu upgrade</span></a><a class="docs-next button" href="/magma/docs/next/proposals/p019_enodeb_cbrs_support"><span>Enodebd CBRS Support</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#context--scope">Context &amp; scope</a><ul class="toc-headings"><li><a href="#goals">Goals</a></li><li><a href="#non-goals">Non-goals</a></li></ul></li><li><a href="#proposal">Proposal</a><ul class="toc-headings"><li><a href="#a-python-free-future">A Python-free Future</a></li></ul></li><li><a href="#alternatives-considered">Alternatives considered</a></li><li><a href="#cross-cutting-concerns">Cross-cutting concerns</a><ul class="toc-headings"><li><a href="#performance">Performance</a></li><li><a href="#deployment">Deployment</a></li><li><a href="#compatibility">Compatibility</a></li><li><a href="#observability-and-debug">Observability and Debug</a></li><li><a href="#security--privacy">Security &amp; privacy</a></li></ul></li><li><a href="#open-issues">Open issues</a></li><li><a href="#original-design">Original design</a><ul class="toc-headings"><li><a href="#performance-impact-of-l2-instrumentation">Performance impact of L2 instrumentation</a></li></ul></li><li><a href="#references">References</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="copyright">Copyright © 2025 The Magma Authors</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'f95caeb7bc059b294eec88e340e5445b',
                indexName: 'magma',
                inputSelector: '#search_input_react'
              });
            </script></body></html>