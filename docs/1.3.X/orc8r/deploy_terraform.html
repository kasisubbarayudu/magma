<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Terraforming Orchestrator on AWS · Magma Documentation</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="# Terraforming Orchestrator on AWS"/><meta name="docsearch:version" content="1.3.X"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Terraforming Orchestrator on AWS · Magma Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://magma.github.io/magma/"/><meta property="og:description" content="# Terraforming Orchestrator on AWS"/><meta property="og:image" content="https://magma.github.io/magma/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://magma.github.io/magma/img/docusaurus.png"/><link rel="shortcut icon" href="/magma/img/icon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script type="text/javascript" src="/init.js"></script><script src="/magma/js/scrollSpy.js"></script><link rel="stylesheet" href="/magma/css/main.css"/><script src="/magma/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/magma/"><img class="logo" src="/magma/img/magma-logo.svg" alt="Magma Documentation"/><h2 class="headerTitleWithLogo">Magma Documentation</h2></a><a href="/magma/versions"><h3>1.3.X</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="https://magmacore.org" target="_self">Magma Website</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="/magma/" target="_self">Docs</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://github.com/magma" target="_self">Code</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://github.com/magma/magma/wiki/Contributor-Guide" target="_self">Contributing</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://wiki.magmacore.org/" target="_self">Wiki</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="terraforming-orchestrator-on-aws"></a><a href="#terraforming-orchestrator-on-aws" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Terraforming Orchestrator on AWS</h1>
<h2><a class="anchor" aria-hidden="true" id="pre-terraform"></a><a href="#pre-terraform" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pre-Terraform</h2>
<p>First, copy the contents of <a href="https://github.com/facebookincubator/magma/tree/master/orc8r/cloud/deploy/terraform">orc8r/cloud/deploy/terraform</a>
into a source-controlled directory that you control. This directory contains
bare-bones Terraform scripts to bring up the raw AWS resources needed for
Orchestrator. We highly recommend familiarizing yourself with <a href="https://www.terraform.io/">Terraform</a>
before continuing - the rest of this guide will assume some familiarity with
both Terraform and the <a href="https://aws.amazon.com/cli/">AWS CLI</a>.</p>
<p>Adjust the example Terraform files as you see fit. If you aren't familiar with
Terraform yet, we recommend not changing anything here for now.</p>
<p>Next <code>cd</code> to where you've copied the contents of the Terraform directory and</p>
<pre><code class="hljs css language-bash">$ terraform init

Initializing modules...
Initializing the backend...
Initializing provider plugins...
Terraform has been successfully initialized!
</code></pre>
<p>In the AWS console, create or import a new keypair to enable SSH access to the
worker nodes of the EKS cluster. This can be found in the EC2 dashboard under
&quot;Key Pairs&quot;. If you're creating a new key pair, make sure not to lose the
private key, you won't be able to recover it from AWS.</p>
<p><img src="/magma/docs/assets/keypair.png" alt="creating an AWS keypair"></p>
<p>Next, create a <code>vars.tfvars</code> file in your directory, <em>add it to your source
control's .ignore</em>, and specify your desired RDS password and the name of the
keypair that you imported or created in the above step:</p>
<pre><code class="hljs css language-bash">$ cat vars.tfvars
db_password = <span class="hljs-string">"foobar"</span>
nms_db_password = <span class="hljs-string">"foobar"</span>
key_name = <span class="hljs-string">"my_key"</span>
</code></pre>
<p>Check the README under the original terraform directory for additional
variables that you can configure.</p>
<p>Now you're ready to move on:</p>
<h2><a class="anchor" aria-hidden="true" id="applying-terraform"></a><a href="#applying-terraform" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Applying Terraform</h2>
<p>Execute your standard Terraform workflow and wait for the resources to finish
provisioning. If you are terraforming on an AWS account that's already being
used for other purposes, carefully examine Terraform's planned execution before
continuing.</p>
<p>Note: There is a known issue with the module we use to provision the EKS
cluster (see <a href="https://github.com/facebookincubator/magma/issues/793">https://github.com/facebookincubator/magma/issues/793</a>).
If you see a stacktrace like the following, simply <code>terraform apply</code> again
and the stack provisioning should succeed</p>
<pre><code class="hljs"><span class="hljs-attribute">Error</span>: Provider produced inconsistent final plan

<span class="reasonml">When expanding the plan for <span class="hljs-keyword">module</span>.eks.aws_autoscaling_group.workers<span class="hljs-literal">[<span class="hljs-number">0</span>]</span> <span class="hljs-keyword">to</span>
<span class="hljs-keyword">include</span> <span class="hljs-keyword">new</span> values learned so far during apply, provider <span class="hljs-string">"aws"</span> produced an
invalid <span class="hljs-keyword">new</span> value for .initial_lifecycle_hook: planned set element
cty.<span class="hljs-constructor">ObjectVal(<span class="hljs-params">map</span>[<span class="hljs-params">string</span>]<span class="hljs-params">cty</span>.Value{<span class="hljs-string">"default_result"</span>:<span class="hljs-params">cty</span>.UnknownVal(<span class="hljs-params">cty</span>.String)</span>,
<span class="hljs-string">"heartbeat_timeout"</span>:cty.<span class="hljs-constructor">UnknownVal(<span class="hljs-params">cty</span>.Number)</span>,
<span class="hljs-string">"lifecycle_transition"</span>:cty.<span class="hljs-constructor">UnknownVal(<span class="hljs-params">cty</span>.String)</span>,
<span class="hljs-string">"name"</span>:cty.<span class="hljs-constructor">UnknownVal(<span class="hljs-params">cty</span>.String)</span>,
<span class="hljs-string">"notification_metadata"</span>:cty.<span class="hljs-constructor">UnknownVal(<span class="hljs-params">cty</span>.String)</span>,
<span class="hljs-string">"notification_target_arn"</span>:cty.<span class="hljs-constructor">UnknownVal(<span class="hljs-params">cty</span>.String)</span>,
<span class="hljs-string">"role_arn"</span>:cty.<span class="hljs-constructor">UnknownVal(<span class="hljs-params">cty</span>.String)</span>}) does not correlate <span class="hljs-keyword">with</span> any element <span class="hljs-keyword">in</span>
actual.
</span></code></pre>
<p>Once <code>terraform apply -var-file=vars.tfvars</code> finishes, there is some additional
manual setup to perform before our EKS cluster is ready to deploy onto.</p>
<p>First find the public IP address of the metrics instance using</p>
<pre><code class="hljs css language-bash"><span class="hljs-built_in">export</span> METRICS_IP=$(aws ec2 describe-instances --filters Name=tag:orc8r-node-type,Values=orc8r-prometheus-node --query <span class="hljs-string">'Reservations[*].Instances[0].PublicIpAddress'</span> --output text)
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$METRICS_IP</span>
</code></pre>
<p>The Prometheus config manager application expects some configuration files to
be seeded in the EBS config volume (don't forget to use the correct private
key in <code>scp</code> with the <code>-i</code> flag):</p>
<pre><code class="hljs css language-bash">scp -r config_defaults ec2-user@<span class="hljs-variable">$METRICS_IP</span>:~
ssh ec2-user@<span class="hljs-variable">$METRICS_IP</span>
[ec2-user@&lt;metrics-ip&gt; ~]$ sudo cp -r config_defaults/. /configs/prometheus
</code></pre>
<p>Now you've got your infra set up, we can move on to configuring the EKS cluster.</p>
<p>Assuming you don't have an existing Kubeconfig file in <code>~/.kube/config</code>, run
the following. If you do, you can use the <code>KUBECONFIG</code> environment variable
and <code>kubeconfig view --flatten</code> to concatenate the kubeconfig file that
Terraform created with your existing kubeconfig.</p>
<pre><code class="hljs css language-bash">cp ./kubeconfig_orc8r ~/.kube/config
</code></pre>
<p>Now we can set up access to the EKS cluster:</p>
<pre><code class="hljs css language-bash">kubectl apply -f config-map-aws-auth_orc8r.yaml
</code></pre>
<p>At this point, our cluster is ready for deploying the application onto.</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#pre-terraform">Pre-Terraform</a></li><li><a href="#applying-terraform">Applying Terraform</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="copyright">Copyright © 2025 The Magma Authors</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'f95caeb7bc059b294eec88e340e5445b',
                indexName: 'magma',
                inputSelector: '#search_input_react'
              });
            </script></body></html>